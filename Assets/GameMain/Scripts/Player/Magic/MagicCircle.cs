using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using UnityGameFramework.Runtime;

namespace MyTimer
{
    public class MagicCircle : EntityLogic
    {
        public float timeLimit;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        public float radius;
        public float distance;
        public float directionX;
        public float directionY;
        private float m_fillAmount;
        public Transform player;
        public  SpriteRenderer spriteRenderer;
        private CountdownTimer m_timer;
        private Vector2 m_magicCirclePosition;
        private Material m_material;
        
        
        private void Start()
        {
            m_magicCirclePosition = new Vector2(directionX,directionY);
            transform.position = m_magicCirclePosition;
            
            m_timer = new CountdownTimer();
            m_timer.OnComplete += OnTimerComplete;
            m_timer.OnTick += CircleChange;
            m_timer.Initialize(timeLimit, true);
            
            float newScale = radius;
            transform.localScale = new Vector2(newScale, newScale);
            
            SpriteRenderer spriteRenderer = GetComponent<SpriteRenderer>();
            m_material = spriteRenderer.material;
        }

        private void Update()
        {
            if (!m_timer.Completed)
            {   
                distance = Vector2.Distance(transform.position,player.position );
                Log.Info(transform.position.x);
                Log.Info(transform.position.y );
                Log.Info(player.position.x);
                Log.Info(player.position.y);
                Log.Info(distance);
                if (IsPlayerInMagicCircle())
                {   
                    Debug.Log("In");
                    OnTimerComplete();
                }
            }
            else
            {
                OnTimerComplete();
            }
        }

        private void CircleChange(float p)
        {
            //Log.Info(p);
            if (m_timer != null && m_material != null)
            {
                float remainingPercent = m_timer.Percent;
                m_fillAmount = Mathf.Clamp01(1 - remainingPercent);
                m_material.SetFloat("_Fill", m_fillAmount);
            } 
            //Log.Info(m_fillAmount);
        }
        
        private bool IsPlayerInMagicCircle()
        {
            return distance <= radius;
        }
        
        private void OnTimerComplete()
        {
            Destroy(gameObject);
            m_timer.Paused = true;
        }
    }
}
